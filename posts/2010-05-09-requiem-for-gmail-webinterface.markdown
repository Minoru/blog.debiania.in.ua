---
title: Requiem for a GMail webinterface
published: 2010-05-09T05:32:00Z
categories: 
tags: web
description: Переход на mutt сотоварищи, а также несколько любопытных ошибок,
    которые я совершил в процессе.
---

На днях я подписался на списки рассылки Debian, и моя привержённость к веб-интерфейсу гуглопочты дала трещину. Работа интерфейса не устраивает меня по ряду причин:<ol><li>при ответе создаётся сообщение, адресованное автору поста, а не в список.</li><li>при цитировании используется неудобный формат текста перед цитатой оригинального поста — там присутствует email автора, но отсутствует часовой пояс цитируемого</li></ol>Обе проблемы идут вразрез с этикетом рассылок, потому-то я и уделяю им столько внимания.

Короче, назрел переход на локальный почтовик, что и было проделано в течении пары дней. Эта заметка написана, так сказать, по горячему следу. Она собрала в себе все проблемы, с которыми я столкнулся. В основном это какие-то мелочи, детали, которых я не знал, но которые оказались важными. Я постарался по возможности превратить пост в гайд, так что будет много ссылок и текста.

Итак, я выбрал популярную и многими обкатанную конфигурацию: <code>fetchmail</code> → <code>procmail</code> → <code>mutt</code> → <code>msmtp</code>. О том, как её настраивать, читайте в <a href="http://www.gentoo.org/doc/ru/guide-to-mutt.xml">Gentoo wiki</a> (для настройки <code>msmtp</code> придётся заглянуть в <a href="http://www.gentoo.org/doc/en/guide-to-mutt.xml">английскую версию</a>). Чтобы лучше понять процесс обработки почты в *nix, советую почитать <a href="http://wiki.mutt.org/?MailConcept">MailConcept</a> — «A short introduction to the notorious MxA bunch». А чтобы понять наконец, как всё это конфигурировать применительно к GMail, взгляните на <a href="http://www.andrews-corner.org/mutt.html">«Using Mutt with Gmail»</a>.

Теперь обратим внимание на некоторые моменты, которые помешали мне быстро и качественно всё отконфигурировать.

Во-первых, я возомнил себя шибко умным, а автора последнего гайда — не сведущим в моих задачах, и потому опцию <code>no keep</code> в настройках <code>fetchmail</code> сменил на <code>keep</code> (мотивируя это тем, что я не хочу удалять почту с сервера). Но помощь гугла <a href="http://mail.google.com/support/bin/answer.py?answer=13287">внятно утверждает</a>, что ничего с моими письмами не произойдёт — получая от клиента команду удалить письмо, GMail предпринимает действие, заданное пользователем (их четыре — можно <i>оставить копию во Входящих</i>, <i>пометить письмо как прочитанное</i>, <i>архивировать</i> или <i>удалить с сервера</i>). По этой причине я долго не мог получить все письма — у меня их около полторы тысячи штук, а POP никак не хочет отдавать больше 460-488-ти за раз. Закончилось всё известной мерой — я попал в <i>Lockdown in section 4</i> на период около шести часов. Эта блокировка распространяется только на POP и IMAP — доступ к веб-интерфейсу остаётся, так что можете не волноваться: что бы ни случилось, почта у вас будет :)

Второй ошибкой было использование ящика типа mbox (все письма в одном файле). Когда я наконец-то пришёл к выводу, что пора бы перестать качать письма с GMail, а юзать локальную копию, оказалось, что предложенный мне рецепт:<div class="code">find $MAILDIR -type f | while read mail; do procmail < "$mail"; done</div>работает только с ящиками типа Maildir (в ящике есть три поддиректории — cur, new и tmp; каждое письмо лежит в отдельном файле). Пришлось в срочном порядке искать способ сконвертировать mbox в maildir, который и нашёлся в лице <a href="http://www.gerg.ca/hacks/mb2md/">mb2md</a>. Правда, в конечном итоге я все равно качал всё заново — но уже в maildir ящик…

Ещё одно важное замечание касается опции <code>fetchmail</code>'а <code>sslfingerprint</code>. По всему интернету приводятся хитрые рецепты вроде скачивания откуда-то SSL сертификата (или поиск оного в недрах <code>ca-certificates</code>) и последующего вычисления отпечатка. Но можно пойти простым путём: указать заведомо неправильный отпечаток, после чего запустить <code>fetchmail</code> с опцией <code>--verbose</code> и посмотреть на вывод. В нём вы найдёте отпечаток, который выслал сервер — его-то и следует указать в конфиге.

Дальше по плану у нас <code>mutt</code>. Вобщем-то, кое-какую рабочую конфигурацию можно набросать уже после прочтения гентушной вики, но я бы посоветовал взглянуть также на <a href="http://www.opennet.ru/docs/RUS/mutt4users/">«Настройку Mutt для чайника»</a>. После этого у вас будет довольно юзабельный почтовик — можете начинать тестить.

Впрочем, предела совершенству нет, и я рискну рассказать о том, что я добавил в <code>.muttrc</code> сверх уже упомянутых в статьях настроек.

Первым дополнением стала адресная книга. Прикрутить такое мирское благо помогла <a href="http://www.linuxcenter.ru/lib/articles/networking/linuxmail.phtml?style=print">статья Дмитрия Аленичева «Настройка почтовой системы в Linux»</a> — там упомянута замечательная тулза по имени <code>abook</code>, реализующая весь необходимый функционал. Для того, чтобы управлять этим чудом прямо из mutt, нужно добавить в конфиг последнего две строки:
```
# Use abook with Mutt
# Q to search
# a to add sender to abook
set query_command="abook --mutt-query '%s'"
macro index,pager a     "|abook --add-email\n" 'add sender to abook'
```
Комментарии, как мне кажется, исчерпывающи.

Вторым важным дополнением стала реализация работы с рассылками (ведь именно они и сподвигли меня на переход к локальному почтовику). Итак, в первую очередь надо приучить <code>mutt</code> отвечать не собственно автору поста, а прямиком в список рассылки:
```
set followup_to = yes
set honor_followup_to = yes
```
Во-вторых, следует объяснить почтовику, на какие рассылки я подписан:
```
subscribe e-mail_рассылки
```
И последнее, чем я особо горжусь — локальные копии отсылаемых сообщений будут ложиться в ящики, соответствующие рассылке:
```
# дефолтный ящик
set record = "+inbox"
# выбираем ящик в зависимости от рассылки
fcc-save-hook ~Cадрессрассылки ящик
```
Прекрасно, не правда ли? ☺

Кстати, вернусь немного назад и расскажу про сортировку рассылок в <code>procmail</code>. К этой задаче есть несколько подходов: некоторые советуют писать правила, используя <code>^TO_</code>, а некоторые настаивают на использовании более рассылко-специфичных полей. Наиболее полное описание проблемы и её решений дано <a href="http://www.ii.com/internet/robots/procmail/qs/#alt2TO">здесь</a>. На тему работы с рассылками в <code>mutt</code> также написана неплохая статья <a href="http://larve.net/people/hugo/2000/07/ml-mutt">«Using Mutt to send emails to mailing lists»</a> — советую почитать и её тоже.

С <code>msmtp</code> — последним звеном нашей почтовой цепочки — проблем вообще никаких: всё просто работает; так что о нём я писать не буду вообще ничего ;)

Happy <code>mutt</code>ing, <code>procmail</code>ing и всего такого прочего!

<h3 id='hakyll-convert-comments-title'>Comments (migrated from Blogger)</h3>
<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T10:03:41.894+03:00, Juev wrote:</p>
<p class='hakyll-convert-comment-body'>
Список рассылки Debian?? <br/>
Слишком много там упертых Одминов. Было дело, пытался читать, общаться. <br/>
В итоге просто отписался. Делать там нечего. А уж ради &quot;такой&quot; рассылки менять клиенты... Извините меня.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T11:18:34.703+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
Хм… А я читаю и пишу с огромным удовольствием.

А в чём выражается упёртость админов, если не секрет?
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T11:42:28.991+03:00, Juev wrote:</p>
<p class='hakyll-convert-comment-body'>
Как раз в следовании стандартам. <br/>
Давно уже все рассылки используют модифицированную версию стандарта при отправлении сообщений в рассылки, тут же четкое следование.<br/>
Удобство использования в расчет не берется. Делается не для людей, а для бумажки. <br/>
Про ответы на вопросы я вообще молчу. Задавать вопросы там очень сложно.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T11:55:54.356+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
Интересно… А о каком стандарте (и какой модифицированной версии) речь? Можно ссылки или хотя бы названия?

Касательно ответов буду возражать. Я лично задал несколько вопросов — на все ответили в течении пары часов. Всё корректно и очень приятно.

И, наверное, мне стоит уточнить, что я говорю о debian-user — она самая активная из тех, на которые я подписан. А ты о какой?
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T12:10:22.285+03:00, Juev wrote:</p>
<p class='hakyll-convert-comment-body'>
Точное название рассылки не помню уже. Точно скажу только одно, она была русскоязычная. 

Стандарт использования использования заголовков почтовых сообщений.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T12:44:06.480+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
<b>&gt; Стандарт использования использования заголовков почтовых сообщений.</b>

Стало быть, речь об List-id, X-mailing-list и прочих? Хм… Меня не раздражает совершенно — написал в procmail правила с использованием List-id и забыл. Если подпишусь ещё на что-то и там будут использоваться другие поля, напишу соответствующие правила. Какая разница, если всё работает?
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T15:37:00.250+03:00, qnikst wrote:</p>
<p class='hakyll-convert-comment-body'>
достаточно интересный вариант использование offlineIMAP вместо связки &quot;fetchmail → procmail&quot;. С его помощью можно получить полную offline копию ящика и простую синхронизацию, что позволяет во-первых получать доступ к почте при отсутствии интернет соединения, во-вторых получать доступ к той же почте, когда есть соединение, но нету самого mutt. 

+ можно ещё использовать для поска mairix 
<a href="http://wiki.mutt.org/?UserStory/SearchingMail" rel="nofollow">тут инфа</a>
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T16:27:51.058+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
IMAP? Да, думал о нём — как-никак, возможностей больше, чем у POP; с другой стороны, я пока что не чувствую, чтобы новая система меня ограничивала — так что всё в порядке.

Спасибо за mairix — вики mutt&#39;а уже читаю, но до историй пользователей ещё не дошёл.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T22:59:45.626+03:00, Анонимный wrote:</p>
<p class='hakyll-convert-comment-body'>
Сам о таком подумывал тока в связке imap + getmail - слышал что fetchmail письма иногда теряет.<br/>
Вопрос однако: а как с теми кто присылает вместо нормальных писем html и картинки всякие - есть способ это всё безгеморойно глядеть или придётся сохранять и смотреть отдельно?
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-09T23:17:00.382+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
Да, способ есть. Читайте <a href="http://www.opennet.ru/docs/RUS/mutt4users/" rel="nofollow">«Настройку mutt для чайника»</a> — там в конце написано про .mailcap, в котором можно сопоставить каждому MIME-типу свой просмотрщик. Пропишешь для text/html iceweasel — и будет тебе счастье :)

Я, правда, использую w3c и доволен — на картинки все равно пофиг, ради них и в веб-интерфейс можно залогиниться.

Мой ~/.mailcap:

text/html;         w3m -T text/html %s; needsterminal;
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-10T03:10:19.254+03:00, Сергей wrote:</p>
<p class='hakyll-convert-comment-body'>
Попробуйте, попробуйте IMAP. POP3 совсем не заточен под хранение почты на сервере, тем более в таких количествах, как на GMail. POP3 позволяет лишь запросить список сообщений и выкачивать их поштучно (и удалять). IMAP же именно и создан для синхронизации удалённого почтового ящика, со всей его структурой (папками и состоянием писем) и локального. В обе стороны. Без потерь писем и без повторных скачиваний. В качестве бонуса при использовании IMAP сохраняется доступ к меткам и фильтру спама GMail. Ещё преимущество в том, что клиенты можно безболезненно менять и читать почту с разных машин. Я, например, использую и Thunderbird, и mutt, и вебинтерфейс. И все они дружно работают с одним и тем же ящиком.

Об OfflineIMAP. Последний раз, когда я его пробовал, года два назад, наблюдал проблемы с кодировками. Проект сейчас сопровождается минимально (фиксятся баги, но развития не планируется). Кстати, сам автор OfflineIMAP сейчас <a href="http://twitter.com/jgoerzen/status/13333112009" rel="nofollow">использует Thunderbird 3</a> на большинстве своих машин.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-10T15:10:29.632+03:00, qnikst wrote:</p>
<p class='hakyll-convert-comment-body'>
&gt; text/html; w3m -T text/html %s; needsterminal; 

бывает полезно добавить w3m -O utf-8 -I %{charset} <br/>
т.к. некоторые почтовики (web интерфейс gmail) любят указывать кодировку только в описании Content-Type вложения, из-за этого w3m может не угадать кодировку.


у меня стоит

&gt; text/html; w3m -O utf8 -I %{charset} -dump %s; copiousoutput; description=HTML Text; nametemplate=%s.html

хотя это возможно излишне.

&gt; Об OfflineIMAP. Последний раз, когда я его пробовал, года два назад, наблюдал проблемы с кодировками.

у меня были проблемы с кодировками названий папок, и была решена переключением на английский интерфейс, хотя есть и более адекватные решения
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-10T17:51:32.128+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
Сергей. вы меня таки убедили — как только найду достаточно времени, настрою себе IMAP.

qnikst, спасибо за совет — хоть я пока и не сталкивался с некорректно отображаемым html, поправлю свой .mailcap
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-11T13:22:57.623+03:00, lizardie wrote:</p>
<p class='hakyll-convert-comment-body'>
&gt;   1. при ответе создаётся сообщение, адресованное автору поста, а не в список.<br/>
Проблема решается ровно тремя щелчками мышки во вкладке Labs.

&gt;   2. при цитировании используется неудобный формат текста перед цитатой оригинального поста — там присутствует email автора, но отсутствует часовой пояс цитируемого<br/>
Я точно не знаю, как это вылечить, но думаю, что несложно сделать, используя Greasemonkey (если вы пользуетесь firefoxом)
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-13T17:53:27.394+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
lizardie, а поточнее можно касательно Labs? Признаю́, что это для меня потёмки.

А вот утяжелять и так неповоротливого огнелиса лишними дополнениями нет никакого желания…
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-14T18:28:13.094+03:00, lizardie wrote:</p>
<p class='hakyll-convert-comment-body'>
ну, в gmail&#39;е в верхней панели справа есть иконка, типа лабораторной колбы - там много разных дополнительных настроек - &quot;crazy experimental stuff&quot;, как они их называют.<br/>
Внизу страницы есть пара ссылок, где можно предложить то, чего тебе в гмайле не хватает, или самому написать.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-05-15T02:57:41.650+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
М, ясно. Я когда-то заглядывал в Лабораторию, увидел там длиннющий список и ужаснулся. Не знал, что там есть кнопка для того, чтобы предложить идею. Надо будет попользоваться. Спасибо!
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-06-12T01:23:59.143+03:00, Анонимный wrote:</p>
<p class='hakyll-convert-comment-body'>
Как-то слишком наворочено все. А зачем столько плясок с бубном если можно использовать какойнить thunderbird и запросто настроить его на ответ в подходящем формате? И почту IMAPом прямо по папкам 1 в 1 синхронизировать. Несколько не unix-way, но в конечном итоге почта попадет в те же mailbox files по сути.
</p>
</div>

<div class='hakyll-convert-comment'>
<p class='hakyll-convert-comment-date'>On 2010-06-12T01:35:09.473+03:00, Minoru wrote:</p>
<p class='hakyll-convert-comment-body'>
Плясок с бубном? Мне нравится узнавать что-то новое, так что я не рассматриваю всё это как скучный и нудный процесс.

Почта у меня <b>уже</b> синхронизируется по IMAP — недавно настроил.
</p>
</div>



